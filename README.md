# rotatrix

**Secure and Automated Log Rotation on Linux Systems**

Ansible role for advanced and secure log rotation management on enterprise Linux servers.

---

## Introduction

This role implements log rotation and retention policies recommended for enterprise Linux environments. It allows customization of settings according to regulatory requirements, storage capacity, or service criticality. It is recommended to review policies annually or after significant infrastructure changes.

---

## Requirements

* Ansible >= 2.9

* Operating system:
  - Red Hat Enterprise Linux 9 (RHEL 9) or compatible

* Root privileges on target nodes

---

## Configurable Variables

The following variables allow customization of log rotation policy deployment to suit the needs of each environment.

They can be easily overridden from a playbook or using `group_vars` or `host_vars`.

| Variable | Default Value	 | Description |
| :---: | :---: | :---: |
| `logrotate_conf_src` | logrotate.conf | Source file for the main logrotate configuration |
| `logrotate_conf_dest` | /etc/logrotate.conf | Destination path for the main logrotate configuration |
| `logrotate_d_dir_src` | logrotate.d | Directory containing individual policy files to be deployed to `/etc/logrotate.d/` |
| `logrotate_d_dir_dest` | /etc/logrotate.d | Destination directory for the individual policy files |
| `logrotate_d_files` | [btmp, dnf, rsyslog, wtmp] | List of specific policy files to be copied to the destination folder |

### Example: Customizing in a Playbook

To deploy only selected policies or override default paths, redefine the variables in your playbook like this:

```yaml
- hosts: servers
  become: true
  roles:
    - role: rotatrix
      vars:
        logrotate_d_files:
          - rsyslog
          - dnf
```

Or to change file locations:

```yaml
- hosts: servers
  become: true
  roles:
    - role: rotatrix
      vars:
        logrotate_conf_dest: /etc/custom-logrotate.conf
        logrotate_d_dir_dest: /etc/custom-logrotate.d
```

---

## Structure of Attached Files

All configuration files referenced in this documentation are located in the `files/etc` directory, ready for deployment on the target system.

Structure:

```plaintext
files/
└── etc/
    ├── logrotate.conf
    └── logrotate.d/
        ├── btmp
        ├── dnf
        ├── rsyslog
        └── wtmp
```

### File Descriptions:

* `logrotate.conf`
  Main logrotate configuration file. Defines global rotation policies and includes specific service policies

* `logrotate.d/btmp`
  Specific rotation policy for failed login attempts log (/var/log/btmp)

* `logrotate.d/dnf`
  Rotation policy for package management logs generated by DNF

* `logrotate.d/rsyslog`
  Rotation policies for logs managed by rsyslog, including system and key service logs

**Note**: Before applying these files in a production environment, review and adjust paths, permissions, and parameters according to your system's specifics and requirements.

---

## Usage Example

Se debe incluir este rol en un playbook de Ansible:

```yaml
- hosts: all
  become: true
  roles:
    - role: rotatrix
```

---

## Testing

To run the included basic tests:

```sh
ansible-playbook -i tests/inventory tests/test.yml
```

---

## Configuration Deployment

### General Configuration (`/etc/logrotate.conf`)

The general `logrotate` configuration sets the default values applied to all log files unless overridden by specific files in `/etc/logrotate.d`.

This global policy applies secure and sensible defaults for server environments:

- **Frequency**: Weekly rotation
- **Retention**: 5 rotated files
- **Max age**: 60 days
- **Minimum size to rotate**: 1 MB
- **Compression**: Enabled, with delayed compression of the latest log
- **Date-based file names**: For better traceability
- **Handles missing or empty files gracefully**
- **Includes policies from `/etc/logrotate.d`**

File location: `/etc/logrotate.conf`

#### Default Applied Parameters

| Directive | Value | Description |
| :---: | :---: | :---: |
| `missingok` | — | Skips missing log files without error |
| `notifempty` | — | Skips empty files |
| `weekly` | — | Default rotation frequency |
| `rotate` | `5` | Number of rotated logs kept |
| `maxage` | `60` days | Max age before deletion |
| `minsize` | `1M` | Minimum size to trigger rotation |
| `dateext` | — | Appends date to rotated file name |
| `compress` | — | Delays compression of the newest log |
| `delaycompress` | — | Retrasa la compresión del archivo más reciente |
| `include` | `/etc/logrotate.d` | Loads service-specific policies |

These options ensure efficient log rotation, data preservation, and a reasonable historical log base without overloading the system.

### Rotation of Failed Authentication Logs

This binary log records all failed login attempts on the system. It is useful for auditing, forensics, or reviewing suspicious access. Given its sensitivity and low frequency, it is rotated more conservatively than others.

- Binary format: should be viewed using lastb
- Not compressed: to remain readable by standard tools
- Long retention: traces failed access for a full year
- Strict permissions: only accessible to authorized system processes

Configuration location: `/etc/logrotate.d/btmp`

#### Rotation Policy (`/var/log/btmp`)

| Files | Rotation Frequency | Copiess | Max Retention | Min Size | Permissions | Notes |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| `/var/log/btmp` | Monthly | 12 | 366 days | 1 MB | `0660` | Failed login attempts (view with lastb) |

### Rotation of Session Logs

This configuration handles rotation of `/var/log/wtmp`, a binary log storing logins, logouts, and reboots. It is used by tools like `last` or `who`, and requires careful handling to preserve historical data integrity.

- Binary file; should not be compressed
- Keeps 12 months of history (1 year)
- Proper permissions for system tool access
- Rotated monthly if over 1 MB

File location: `/etc/logrotate.d/wtmp`

#### Política de rotación de log de sesiones (`/etc/logrotate.d/wtmp`)

| File | Rotation Frequency | Copiess | Max Retention | Min Size | Permissions | Notes |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| `/var/log/wtmp` | Monthly | 12 | 366 days | 1 MB | `0664` | 	Logins, logouts, reboots (view with `last`, `who`). Not compressed due to binary format |

### Rotation of System Logs

This `logrotate` configuration for `rsyslog` implements secure and efficient rotation policies:

- Retention tailored to each log’s criticality
- Automatic compression of older logs
- Restrictive permissions for sensitive files (`secure`, `maillog`, etc.)
- Avoids unnecessary rotations using minsize
- Automatically reloads `rsyslog` after rotation to prevent data loss

File location: `/etc/logrotate.d/rsyslog`

#### System Log Rotation Policy (`/etc/logrotate.d/rsyslog`)

A continuación se detallan los parámetros aplicados a cada uno de los logs gestionados por `rsyslog`:

| File | Rotation Frequency | Copies | Max Retention | Min Size | Permissions | Notes |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| `/var/log/boot.log` | Weekly | 5 | 60 days | 1 MB | `0664` | Boot messages |
| `/var/log/cron` | Weekly | 14 | 180 days | 1 MB | `0664` | Scheduled task activity |
| `/var/log/maillog` | Weekly | 14 | 180 days | 1 MB | `0600` | Mail services (Postfix, etc.) |
| `/var/log/messages` | Weekly | 14 | 180 days | 1 MB | `0600` | General system messages |
| `/var/log/secure` | Weekly | 12 | 366 days | 1 MB | `0600` | Access, authentication, sudo, SSH |
| `/var/log/spooler` | Weekly | 5 | 60 days | 1 MB | `0600` | Print services (CUPS, etc.) |

### Rotation of Package Management Logs (DNF)

This `logrotate` configuration handles rotation for logs generated by DNF (`dnf`, `hawkey`, `librepo`, `rpm`) to ensure reasonable retention, space efficiency, and traceability of package operations.

- Retention matched to system usage
- Automatic compression of old logs
- Avoids unnecessary rotations with `minsize`
- No service reload required after rotation

File location: `/etc/logrotate.d/dnf`

#### Política de rotación de logs de DNF (`/etc/logrotate.d/dnf`)

A continuación se detallan los parámetros aplicados a cada uno de los logs relacionados con la gestión de paquetes:

| File | Rotation frequency | Copies | Max Retention | Min Size | Permissions| Notes |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| `/var/log/dnf.log` | Weekly | 14 | 180 days | 1 MB | `0644` | High-level operations (`dnf install`, etc.) |
| `/var/log/hawkey.log` | Weekly | 14 | 180 days | 1 MB | `0644` | Dependency resolution (`libsolv` engine) |
| `/var/log/dnf.rpm.log` | Weekly | 14 | 180 days | 1 MB | `0644` | Package installation/update info |
| `/var/log/dnf.librepo.log` | Weekly | 14 | 180 days | 1 MB | `0644` | Downloads and remote repository access |

---

## Important Notes and Warnings

### Important Note on Binary Logs (wtmp, btmp)

Binary log files like `/var/log/btmp` and `/var/log/wtmp` must never be compressed or manually edited. Altering them can corrupt the data and make them unreadable by standard system tools like `lastb`, `last`, or `who`. Always use the appropriate system utilities to view them and never edit, delete, or modify them outside of the automated rotation process.

---

## Advanced Parameters and Recommendations

### Handling Oversized Logs

In cases where logs may grow unpredictably (e.g., after an incident or service failure), you can use the `maxsize` directive in logrotate to force rotation when a log file exceeds a specified maximum size, regardless of the scheduled frequency.

Example:

```shell
maxsize 100M
```

This ensures that the log is rotated once it exceeds 100 MB, helping to prevent disk space issues or data loss due to overly large files.

**Note**: Note: This directive is not included in the provided configurations by default but can be added in critical environments or when specifically required.

---

## Additional References

* [logrotate man page](https://linux.die.net/man/8/logrotate)

* [Official logrotate documentation](https://man7.org/linux/man-pages/man8/logrotate.8.html)

It is recommended to consult these resources for advanced configuration details and specific troubleshooting.

---

## Contributing

Suggestions, improvements, or issues? Nothing beats a Merge Request (MR) on this repository - we’ll review it!

---

## License

This repository is distributed under the MIT License. See the [LICENSE](LICENSE) file for more details.
